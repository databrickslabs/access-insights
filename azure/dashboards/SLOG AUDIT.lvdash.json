{"datasets":[{"name":"bf54e1c5","displayName":"storage_logs_information_schema","query":"select\n  *\nfrom\n  slog.default.azure_storage_logs"},{"name":"cc28345c","displayName":"matched_stats","query":"SELECT\n  Date(storage_time) `StorageTime`,\n  storage_accountName,\n  info_tableType,\n  storage_Action,\n  sum(case when match_found = 1 then 1 else 0 end) as `Matches`,\n  sum(case when match_found = 0 then 1 else 0 end) as `Non-Matches`\nFROM\n  slog.default.azure_storage_logs\nGroup BY All"},{"name":"b84d3ce6","displayName":"Good Candidates for Migration","query":"-- Get the latest timestamp for the \"eventhub_storage_log_setup\" job\nwith last_run_timestamp as (\n  select\n    max(period_start_time) as last_run_timestamp\n  from\n    system.lakeflow.job_run_timeline\n  where\n    job_id = '1072068050595527'\n)\n\n-- Identify list of tables that are good candidates to move to managed tables\nselect\n  src.Storage_AccountName,\n  -- max(src.Event_Log_TS) as Event_Log_TS,\n  last_run_timestamp.last_run_timestamp as Job_Run_TS,\n  src.info_tableName,\n\n  -- Get read, write, and delete counts\n  coalesce(sum(case when src.Storage_Action = 'read' then src.operation_count else 0 end), 0) as total_read_count,\n  coalesce(sum(case when src.Storage_Action = 'write' then src.operation_count else 0 end), 0) + coalesce(sum(case when src.Storage_Action = 'delete' then src.operation_count else 0 end), 0) as write_delete_count,\n\n  -- Capture external tables with no writes or deletes as good candidates\n  case\n    when coalesce(sum(case when src.Storage_Action = 'write' then src.operation_count else 0 end), 0) + coalesce(sum(case when src.Storage_Action = 'delete' then src.operation_count else 0 end), 0) = 0 then 1\n    else 0\n  end as good_candidate,\n\n  -- TO DO: Capture non-externally accessed databricks tables with any operation\n  \n  -- Identify external tables that were accessed by an external platform\n  case\n    when\n      sum(\n        case\n          when lower(src.Storage_userAgentHeader) like '%databricks%' then 1\n          else 0\n        end\n      ) > 0\n    then\n      0\n    else 1\n  end as from_external_platform\n\n -- Group and Filter\nfrom\n  (\n    select\n      Storage_AccountName,\n      -- Max(Storage_Time) `Event_Log_TS`,\n      Date(Storage_Time) `Storage_Date`,\n      lower(Storage_userAgentHeader) as Storage_userAgentHeader,\n      info_tableName,\n      info_tableType,\n      Storage_Action,\n      count(*) as operation_count\n    from\n      slog.default.azure_storage_logs\n    where\n      info_tableType = 'EXTERNAL' and\n      Storage_Action in ('read', 'write', 'delete')\n    group by\n      Storage_AccountName,\n      Storage_Time,\n      Storage_userAgentHeader,\n      info_tableName,\n      info_tableType,\n      Storage_Action\n  ) src\n  join last_run_timestamp\ngroup by\n  src.Storage_AccountName,\n  src.info_tableName,\n  last_run_timestamp.last_run_timestamp\norder by\n  total_read_count desc,\n  write_delete_count desc"}],"pages":[{"name":"c82f929a","displayName":"Comparison","layout":[{"widget":{"name":"45aac6e0","queries":[{"name":"dashboards/01f005d6067117e0b7f1e7a8db16fadb/datasets/01f005d606711cffa0aae964f8dc2c81_Storage_Time","query":{"datasetName":"bf54e1c5","fields":[{"name":"Storage_Time","expression":"`Storage_Time`"},{"name":"Storage_Time_associativity","expression":"COUNT_IF(`associative_filter_predicate_group`)"}],"disaggregated":false}}],"spec":{"version":2,"widgetType":"filter-date-range-picker","encodings":{"fields":[{"fieldName":"Storage_Time","displayName":"Storage_Time","queryName":"dashboards/01f005d6067117e0b7f1e7a8db16fadb/datasets/01f005d606711cffa0aae964f8dc2c81_Storage_Time"}]},"frame":{"showTitle":true,"title":"Date"},"selection":{"defaultSelection":{"range":{"dataType":"DATETIME","min":{"value":"now-7d/d"},"max":{"value":"now/d"}}}}}},"position":{"x":0,"y":0,"width":2,"height":1}},{"widget":{"name":"76ab88cb","queries":[{"name":"dashboards/01f005d6067117e0b7f1e7a8db16fadb/datasets/01f005d606711cffa0aae964f8dc2c81_Match_Found","query":{"datasetName":"bf54e1c5","fields":[{"name":"Match_Found","expression":"`Match_Found`"},{"name":"Match_Found_associativity","expression":"COUNT_IF(`associative_filter_predicate_group`)"}],"disaggregated":false}}],"spec":{"version":2,"widgetType":"filter-single-select","encodings":{"fields":[{"fieldName":"Match_Found","displayName":"Match_Found","queryName":"dashboards/01f005d6067117e0b7f1e7a8db16fadb/datasets/01f005d606711cffa0aae964f8dc2c81_Match_Found"}]},"frame":{"showTitle":true,"title":"Match"}}},"position":{"x":4,"y":0,"width":2,"height":1}},{"widget":{"name":"b200c7a6","queries":[{"name":"dashboards/01efee2fdeb116f1ae0f7d52e7fe4d0e/datasets/01eff52252b71f94b7d6cd9c5bdac6ef_Storage_PrincipalId","query":{"datasetName":"bf54e1c5","fields":[{"name":"Storage_PrincipalId","expression":"`Storage_PrincipalId`"},{"name":"Storage_PrincipalId_associativity","expression":"COUNT_IF(`associative_filter_predicate_group`)"}],"disaggregated":false}}],"spec":{"version":2,"widgetType":"filter-single-select","encodings":{"fields":[{"fieldName":"Storage_PrincipalId","displayName":"Storage_PrincipalId","queryName":"dashboards/01efee2fdeb116f1ae0f7d52e7fe4d0e/datasets/01eff52252b71f94b7d6cd9c5bdac6ef_Storage_PrincipalId"}]},"frame":{"showTitle":true,"showDescription":false,"title":"Principal"}}},"position":{"x":2,"y":0,"width":2,"height":1}},{"widget":{"name":"a6fee368","queries":[{"name":"dashboards/01f024fbbe2d1dc385e307f25e0950d9/datasets/01f026adbd251973a0112482d4ed1e66_info_tableName","query":{"datasetName":"bf54e1c5","fields":[{"name":"info_tableName","expression":"`info_tableName`"},{"name":"info_tableName_associativity","expression":"COUNT_IF(`associative_filter_predicate_group`)"}],"disaggregated":false}}],"spec":{"version":2,"widgetType":"filter-multi-select","encodings":{"fields":[{"fieldName":"info_tableName","displayName":"info_tableName","queryName":"dashboards/01f024fbbe2d1dc385e307f25e0950d9/datasets/01f026adbd251973a0112482d4ed1e66_info_tableName"}]},"frame":{"showTitle":true,"title":"Object"}}},"position":{"x":0,"y":1,"width":2,"height":1}},{"widget":{"name":"781ec627","queries":[{"name":"dashboards/01f005d6067117e0b7f1e7a8db16fadb/datasets/01f005d606711cffa0aae964f8dc2c81_Storage_AuthenticationType","query":{"datasetName":"bf54e1c5","fields":[{"name":"Storage_AuthenticationType","expression":"`Storage_AuthenticationType`"},{"name":"Storage_AuthenticationType_associativity","expression":"COUNT_IF(`associative_filter_predicate_group`)"}],"disaggregated":false}}],"spec":{"version":2,"widgetType":"filter-single-select","encodings":{"fields":[{"fieldName":"Storage_AuthenticationType","displayName":"Storage_AuthenticationType","queryName":"dashboards/01f005d6067117e0b7f1e7a8db16fadb/datasets/01f005d606711cffa0aae964f8dc2c81_Storage_AuthenticationType"}]},"frame":{"showTitle":true,"title":"Auth"}}},"position":{"x":2,"y":1,"width":2,"height":1}},{"widget":{"name":"9601b51d","queries":[{"name":"dashboards/01f005d6067117e0b7f1e7a8db16fadb/datasets/01f005d606711cffa0aae964f8dc2c81_Storage_Action","query":{"datasetName":"bf54e1c5","fields":[{"name":"Storage_Action","expression":"`Storage_Action`"},{"name":"Storage_Action_associativity","expression":"COUNT_IF(`associative_filter_predicate_group`)"}],"disaggregated":false}}],"spec":{"version":2,"widgetType":"filter-single-select","encodings":{"fields":[{"fieldName":"Storage_Action","displayName":"Storage_Action","queryName":"dashboards/01f005d6067117e0b7f1e7a8db16fadb/datasets/01f005d606711cffa0aae964f8dc2c81_Storage_Action"}]},"frame":{"showTitle":true,"title":"Operation"}}},"position":{"x":0,"y":2,"width":2,"height":1}},{"widget":{"name":"044b103c","queries":[{"name":"dashboards/01f005d6067117e0b7f1e7a8db16fadb/datasets/01f005d606711cffa0aae964f8dc2c81_Storage_AccountName","query":{"datasetName":"bf54e1c5","fields":[{"name":"Storage_AccountName","expression":"`Storage_AccountName`"},{"name":"Storage_AccountName_associativity","expression":"COUNT_IF(`associative_filter_predicate_group`)"}],"disaggregated":false}}],"spec":{"version":2,"widgetType":"filter-single-select","encodings":{"fields":[{"fieldName":"Storage_AccountName","displayName":"Storage_AccountName","queryName":"dashboards/01f005d6067117e0b7f1e7a8db16fadb/datasets/01f005d606711cffa0aae964f8dc2c81_Storage_AccountName"}]},"frame":{"showTitle":true,"title":"Account"}}},"position":{"x":4,"y":1,"width":2,"height":1}},{"widget":{"name":"526f4850","queries":[{"name":"dashboards/01f024fbbe2d1dc385e307f25e0950d9/datasets/01f026adbd251973a0112482d4ed1e66_info_tableType","query":{"datasetName":"bf54e1c5","fields":[{"name":"info_tableType","expression":"`info_tableType`"},{"name":"info_tableType_associativity","expression":"COUNT_IF(`associative_filter_predicate_group`)"}],"disaggregated":false}}],"spec":{"version":2,"widgetType":"filter-single-select","encodings":{"fields":[{"fieldName":"info_tableType","displayName":"info_tableType","queryName":"dashboards/01f024fbbe2d1dc385e307f25e0950d9/datasets/01f026adbd251973a0112482d4ed1e66_info_tableType"}]},"frame":{"showTitle":true,"title":"Type"}}},"position":{"x":2,"y":2,"width":2,"height":1}},{"widget":{"name":"d5bccc8e","queries":[{"name":"main_query","query":{"datasetName":"bf54e1c5","fields":[{"name":"count(*)","expression":"COUNT(`*`)"},{"name":"info_tableName","expression":"`info_tableName`"}],"disaggregated":false}}],"spec":{"version":3,"widgetType":"pie","encodings":{"angle":{"fieldName":"count(*)","scale":{"type":"quantitative"},"displayName":"Count of Records"},"color":{"fieldName":"info_tableName","scale":{"type":"categorical"},"displayName":"info_tableName"},"label":{"show":true}},"frame":{"showTitle":true,"title":"Table Popularity"}}},"position":{"x":0,"y":9,"width":3,"height":6}},{"widget":{"name":"9aa44563","queries":[{"name":"main_query","query":{"datasetName":"cc28345c","fields":[{"name":"info_tableType","expression":"`info_tableType`"},{"name":"storage_Action","expression":"`storage_Action`"},{"name":"monthly(StorageTime)","expression":"DATE_TRUNC(\"MONTH\", `StorageTime`)"},{"name":"sum(Matches)","expression":"SUM(`Matches`)"},{"name":"sum(Non-Matches)","expression":"SUM(`Non-Matches`)"}],"cubeGroupingSets":{"sets":[{"fieldNames":["info_tableType","storage_Action"]},{"fieldNames":["monthly(StorageTime)"]}]},"disaggregated":false,"orders":[{"direction":"ASC","expression":"`info_tableType`"},{"direction":"ASC","expression":"`storage_Action`"},{"direction":"ASC","expression":"DATE_TRUNC(\"MONTH\", `StorageTime`)"}]}}],"spec":{"version":3,"widgetType":"pivot","encodings":{"rows":[{"fieldName":"info_tableType","displayName":"info_tableType"},{"fieldName":"storage_Action","displayName":"storage_Action"}],"columns":[{"fieldName":"monthly(StorageTime)","displayName":"StorageTime"}],"cell":{"type":"multi-cell","fields":[{"fieldName":"sum(Matches)","cellType":"text","displayName":"Sum of Matches"},{"fieldName":"sum(Non-Matches)","cellType":"text","displayName":"Sum of Non-Matches"}]}},"frame":{"showTitle":true,"title":""}}},"position":{"x":0,"y":15,"width":6,"height":6}},{"widget":{"name":"ad4fe0af","queries":[{"name":"main_query","query":{"datasetName":"bf54e1c5","fields":[{"name":"info_tableType","expression":"`info_tableType`"},{"name":"countdistinct(info_tableName)","expression":"COUNT(DISTINCT `info_tableName`)"}],"cubeGroupingSets":{"sets":[{"fieldNames":["info_tableType"]},{}]},"disaggregated":false,"orders":[{"direction":"ASC","expression":"`info_tableType`"}]}}],"spec":{"version":3,"widgetType":"pivot","encodings":{"rows":[{"fieldName":"info_tableType","displayName":"info_tableType"}],"cell":{"type":"multi-cell","fields":[{"fieldName":"countdistinct(info_tableName)","cellType":"text","displayName":"Count of Unique info_tableName"}]}}}},"position":{"x":3,"y":9,"width":3,"height":6}},{"widget":{"name":"812e4e75","queries":[{"name":"main_query","query":{"datasetName":"b84d3ce6","fields":[{"name":"good_candidate","expression":"`good_candidate`"},{"name":"Storage_AccountName","expression":"`Storage_AccountName`"},{"name":"Job_Run_TS","expression":"`Job_Run_TS`"},{"name":"total_read_count","expression":"`total_read_count`"},{"name":"write_delete_count","expression":"`write_delete_count`"},{"name":"from_external_platform","expression":"`from_external_platform`"}],"disaggregated":true}}],"spec":{"version":1,"widgetType":"table","encodings":{"columns":[{"fieldName":"good_candidate","numberFormat":"0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"integer","displayAs":"number","visible":true,"order":0,"title":"good_candidate","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"cellFormat":{"default":{"foregroundColor":null},"rules":[{"if":{"column":"good_candidate","fn":"=","literal":"1"},"value":{"foregroundColor":"#00A972"}}]},"displayName":"good_candidate"},{"fieldName":"Storage_AccountName","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"string","displayAs":"string","visible":true,"order":1,"title":"Storage_AccountName","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"Storage_AccountName"},{"fieldName":"Job_Run_TS","dateTimeFormat":"YYYY-MM-DD HH:mm:ss.SSS","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"datetime","displayAs":"datetime","visible":true,"order":2,"title":"Job_Run_TS","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"Job_Run_TS"},{"fieldName":"total_read_count","numberFormat":"0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"integer","displayAs":"number","visible":true,"order":4,"title":"total_read_count","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"total_read_count"},{"fieldName":"write_delete_count","numberFormat":"0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"integer","displayAs":"number","visible":true,"order":5,"title":"write_delete_count","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"write_delete_count"},{"fieldName":"from_external_platform","numberFormat":"0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"integer","displayAs":"number","visible":true,"order":6,"title":"from_external_platform","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"from_external_platform"}]},"invisibleColumns":[{"booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"info_tableName","type":"string","displayAs":"string","order":100002,"title":"info_tableName","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false}],"allowHTMLByDefault":false,"itemsPerPage":25,"paginationSize":"default","condensed":true,"withRowNumber":false,"frame":{"showTitle":true,"title":"External Table Candidates"}}},"position":{"x":0,"y":3,"width":6,"height":6}},{"widget":{"name":"9e27811f","queries":[{"name":"dashboards/01f005d6067117e0b7f1e7a8db16fadb/datasets/01f01bb9d9d71bcc911b858ef171b91d_good_candidate","query":{"datasetName":"b84d3ce6","fields":[{"name":"good_candidate","expression":"`good_candidate`"},{"name":"good_candidate_associativity","expression":"COUNT_IF(`associative_filter_predicate_group`)"}],"disaggregated":false}}],"spec":{"version":2,"widgetType":"filter-single-select","encodings":{"fields":[{"fieldName":"good_candidate","displayName":"good_candidate","queryName":"dashboards/01f005d6067117e0b7f1e7a8db16fadb/datasets/01f01bb9d9d71bcc911b858ef171b91d_good_candidate"}]},"frame":{"showTitle":true,"title":"Good Candidate"}}},"position":{"x":4,"y":2,"width":2,"height":1}}]}]}
